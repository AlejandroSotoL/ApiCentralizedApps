@model List<CentralizedApps.Models.Entities.Department>
@{
    ViewData["Title"] = "Gestión de Departamentos";
    Layout = "Layout";
}

<link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
    body, .nunito-font {
        font-family: 'Nunito Sans', sans-serif !important;
        font-weight: 700;
    }

    .custom-action-btn {
        background-color: #516FE9 !important;
        width: 159px;
        height: 40px;
        color: white !important;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        border: none;
        font-weight: 700;
        font-size: 14px;
        transition: transform 0.1s ease, box-shadow 0.2s ease;
        cursor: pointer;
    }

    .custom-action-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 6px -1px rgba(81, 111, 233, 0.4);
    }

    .custom-action-btn:active {
        transform: scale(0.98);
    }

    .custom-card {
        background-color: #F5F6FA !important;
        border: 1px solid #E5E7EB;
    }

    [data-theme="dark"] .custom-card {
        background-color: #1f2937 !important;
        border: 1px solid #374151;
    }

    .custom-input {
        min-height: 48px;
    }
</style>

<div class="w-full max-w-7xl mx-auto space-y-6">
    <!-- Header -->
    <header class="flex justify-center rounded-lg bg-base-100 p-10 shadow-md">
        <h2 class="text-3xl font-bold tracking-wide text-base-content">
            Gestión de Departamentos
        </h2>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        
        <!-- Create Department Section -->
        <section class="rounded-xl bg-base-100 p-6 shadow-lg h-full">
            <h3 class="text-xl font-bold text-base-content mb-6 flex items-center gap-2">
                <span class="bg-green-100 text-green-600 p-2 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                </span>
                Crear Departamento
            </h3>
            
            <form id="createDepartmentForm" onsubmit="createDepartment(event)">
                <div class="mb-6">
                    <label class="block text-sm font-semibold opacity-80 mb-2 ml-2">Nombre del Departamento</label>
                    <input type="text" name="Name" class="custom-input block w-full rounded-full border-0 bg-base-200 py-3.5 px-5 text-base-content shadow-sm ring-1 ring-inset ring-base-300 placeholder:opacity-50 focus:bg-base-100 focus:ring-2 focus:ring-green-500 sm:text-sm transition-all" placeholder="Ej: Cundinamarca" required />
                </div>
                <div class="flex justify-end">
                    <button type="submit" class="custom-action-btn shadow-sm hover:shadow-md bg-green-600 hover:bg-green-700 !bg-green-600">
                        Crear
                    </button>
                </div>
            </form>
        </section>

        <!-- Edit Department Section -->
        <section class="rounded-xl bg-base-100 p-6 shadow-lg h-full">
            <h3 class="text-xl font-bold text-base-content mb-6 flex items-center gap-2">
                <span class="bg-blue-100 text-blue-600 p-2 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                    </svg>
                </span>
                Editar Departamento
            </h3>

            <div class="mb-6">
                <label class="block text-sm font-semibold opacity-80 mb-2 ml-2">Seleccionar Departamento</label>
                <select id="selectDepartment" onchange="loadDepartmentForEdit()" class="custom-input block w-full rounded-full border-0 bg-base-200 py-3.5 px-5 text-base-content shadow-sm ring-1 ring-inset ring-base-300 focus:bg-base-100 focus:ring-2 focus:ring-blue-500 sm:text-sm transition-all cursor-pointer">
                    <option value="" disabled selected>Seleccione un departamento...</option>
                    @foreach (var department in Model.OrderBy(d => d.Name))
                    {
                        <option value="@department.Id">@department.Name</option>
                    }
                </select>
            </div>

            <form id="editDepartmentForm" onsubmit="updateDepartment(event)" class="hidden">
                <input type="hidden" id="editDepartmentId" name="id" />
                <div class="mb-6">
                    <label class="block text-sm font-semibold opacity-80 mb-2 ml-2">Nuevo Nombre</label>
                    <input type="text" id="editDepartmentName" name="Name" class="custom-input block w-full rounded-full border-0 bg-base-200 py-3.5 px-5 text-base-content shadow-sm ring-1 ring-inset ring-base-300 placeholder:opacity-50 focus:bg-base-100 focus:ring-2 focus:ring-blue-500 sm:text-sm transition-all" required />
                </div>
                <div class="flex justify-end">
                    <button type="submit" class="custom-action-btn shadow-sm hover:shadow-md">
                        Guardar Cambios
                    </button>
                </div>
            </form>
        </section>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    async function createDepartment(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);

        try {
            const response = await fetch('@Url.Action("createDeparment", "Municipality")', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                Swal.fire({ icon: 'success', title: 'Éxito', text: 'Departamento creado', timer: 1500, showConfirmButton: false })
                    .then(() => location.reload()); // Reload to update list
            } else {
                Swal.fire({ icon: 'error', title: 'Error', text: 'No se pudo crear el departamento' });
            }
        } catch (error) {
            Swal.fire({ icon: 'error', title: 'Error', text: 'Error de conexión' });
        }
    }

    function loadDepartmentForEdit() {
        const select = document.getElementById('selectDepartment');
        const id = select.value;
        const name = select.options[select.selectedIndex].text;
        
        if (id) {
            document.getElementById('editDepartmentId').value = id;
            document.getElementById('editDepartmentName').value = name;
            document.getElementById('editDepartmentForm').classList.remove('hidden');
        } else {
            document.getElementById('editDepartmentForm').classList.add('hidden');
        }
    }

    async function updateDepartment(event) {
        event.preventDefault();
        const id = document.getElementById('editDepartmentId').value;
        const form = event.target;
        const formData = new FormData(form);

        try {
            const response = await fetch(`@Url.Action("updatedeparment", "Municipality")?id=${id}`, {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                Swal.fire({ icon: 'success', title: 'Actualizado', text: 'Departamento actualizado', timer: 1500, showConfirmButton: false })
                    .then(() => location.reload()); // Reload to update list
            } else {
                Swal.fire({ icon: 'error', title: 'Error', text: 'No se pudo actualizar el departamento' });
            }
        } catch (error) {
            Swal.fire({ icon: 'error', title: 'Error', text: 'Error de conexión' });
        }
    }
</script>