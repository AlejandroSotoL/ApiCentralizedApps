@model CentralizedApps.Models.Dtos.CreateMunicipalityProcedures_Web

@{
    ViewData["Title"] = "Procesos de una Alcaldía";
    Layout = "Layout";
}

<header class="bg-stone-400 p-10 rounded-lg shadow-md flex justify-center">
    <h2 class="text-3xl font-bold text-white tracking-wide">
        Procesos de las Alcaldías
    </h2>
</header>

<div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-8">

    <section class="bg-white rounded-xl shadow-lg p-6">
        <h3 class="font-semibold text-lg text-stone-700 mb-2">
            Procesos disponibles
        </h3>
        <p class="text-sm text-stone-500 mb-4">
            Esta lista muestra los procesos generales que se pueden asignar a cualquier Alcaldía.
        </p>

        @if (Model?.Procedures?.Any() == true)
        {
            <select
                class="w-full rounded-lg border border-stone-300 p-2 text-sm focus:outline-none focus:ring-2 focus:ring-stone-400">
                <option selected disabled>Selecciona un proceso</option>
                @foreach (var x in Model.Procedures)
                {
                    <option value="@x.Id">@x.Name</option>
                }
            </select>
        }
        else
        {
            <div class="p-4 bg-red-100 text-red-700 rounded-lg shadow-sm text-sm">
                No hay procesos disponibles actualmente.
            </div>
        }
    </section>

    <section class="bg-white rounded-xl shadow-lg p-6">
        <h3 class="font-semibold text-lg text-stone-700">
            Alcaldías con procesos
        </h3>
        <p class="text-sm text-stone-500 mb-4">
            Selecciona una Alcaldía para visualizar y administrar sus procesos.
        </p>

        @if (Model?.Municipalities?.Any() == true)
        {
            <form asp-controller="GeneralProcedures" asp-action="BringResultById" method="post" class="w-full">
                <select name="id"
                        class="w-full rounded-lg border border-stone-300 p-2 text-sm focus:outline-none focus:ring-2 focus:ring-stone-400"
                        onchange="this.form.submit()">
                    <option selected disabled>Selecciona una Alcaldía</option>
                    @foreach (var x in Model.Municipalities)
                    {
                        <option value="@x.Id">@x.Name</option>
                    }
                </select>
                <button type="submit" hidden></button>
            </form>
        }
        else
        {
            <div class="p-4 bg-red-100 text-red-700 rounded-lg shadow-sm text-sm">
                No hay alcaldías disponibles actualmente.
            </div>
        }
    </section>
</div>

@if (Model?.ProceduresWithRelations?.Any() == true)
{
    <section class="mt-10 w-full">
        <h3 class="text-xl font-semibold text-stone-700 mb-4">
            Procesos de la Alcaldía seleccionada
        </h3>
        <p class="text-sm text-stone-500 mb-6">
            Desde aquí puedes cambiar el proceso asignado, actualizar el tipo de integración o activar/desactivar cada proceso.
        </p>

        <div class="space-y-6">
            @foreach (var item in Model.ProceduresWithRelations)
            {
                <form asp-controller="GeneralProcedures" asp-action="UpdateMunicipalityProcedure" method="post"
                        class="border border-stone-300 rounded-xl shadow-md overflow-hidden p-5 bg-white">
                    
                    <input type="hidden" name="MunicipalityId" value="@item.Municipality?.Id" />
                    <input type="hidden" name="ProcedureRelationId" value="@item.Id" />

                    <p class="text-sm text-stone-800 mb-6">
                Recuerda que esta infor
                </p>

                    <div class="bg-stone-100 px-4 py-2 mb-4 rounded-lg">
                        <span class="font-semibold text-stone-700">
                            @item.Municipality?.Name - Proceso actual: @item.Procedures?.Name
                        </span>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div>
                            <p><strong>Dominio:</strong> @item.Municipality?.Domain</p>
                            <p><strong>Estado Alcaldía:</strong> @(item.Municipality?.IsActive == true ? "Activa" : "Inactiva")</p>
                        </div>

                        <div>
                            <label class="block text-xs text-stone-600 mb-1">Cambiar Proceso:</label>
                            @if (Model?.Procedures?.Any() == true)
                            {
                                <select name="NewProcedureId"
                                        class="w-full rounded-lg border border-stone-300 p-2 text-sm focus:outline-none focus:ring-2 focus:ring-stone-400">
                                    <option value="@item.Procedures?.Id" selected>@item.Procedures?.Name (actual)</option>
                                    @foreach (var x in Model.Procedures.Where(p => p.Id != item.Procedures?.Id))
                                    {
                                        <option value="@x.Id">@x.Name</option>
                                    }
                                </select>
                                <p class="text-xs text-stone-500 mt-1">Selecciona un proceso diferente para reemplazar el actual.</p>
                            }
                            else
                            {
                                <div class="p-2 bg-red-100 text-red-700 rounded-lg text-xs mt-1">
                                    No hay procesos disponibles actualmente.
                                </div>
                            }
                        </div>
                    </div>

                    <hr class="my-4" />

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs text-stone-600 mb-1">Tipo de Integración:</label>
                            <input type="text" name="IntegrationType"
                                    class="w-full border border-stone-300 rounded-lg p-2 text-sm"
                                    value="@item.IntegrationType" />
                            <p class="text-xs text-stone-500 mt-1">
                                Si cambias este valor y presionas <strong>Guardar</strong>, se actualizará en la base de datos.
                            </p>
                        </div>

                        <div>
                            <label class="block text-xs text-stone-600 mb-1">Estado del Proceso:</label>
                            <input type="checkbox" name="IsActive" value="true"
                                    class="toggle toggle-success"
                                    @(item.IsActive == true ? "checked" : "") />
                            <p class="text-xs text-stone-500 mt-1">
                                Marca o desmarca para activar o desactivar este proceso.
                            </p>
                        </div>
                    </div>

                    <div class="mt-6 flex justify-end">
                        <button type="submit"
                                class="px-5 py-2 bg-yellow-500 text-white font-medium text-sm rounded-lg shadow hover:bg-yellow-600">
                            Guardar cambios
                        </button>
                    </div>
                </form>
            }
        </div>
    </section>
}
else
{
    <section class="mt-10">
        <div class="p-4 bg-yellow-100 text-yellow-700 rounded-lg shadow-sm text-sm">
            No hay procesos relacionados con la Alcaldía seleccionada.
        </div>
    </section>
}
