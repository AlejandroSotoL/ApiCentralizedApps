@model CentralizedApps.Models.Dtos.MunicipalitiesAndSocialMediaTypeDto
@{
    ViewData["Title"] = "Administrar redes sociales";
    Layout = "Layout";
    var lastMunicipalityId = ViewBag.LastMunicipalityId;
    var lastMunicipalityName = ViewBag.LastMunicipalityName;
}

<link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
    body, .nunito-font {
        font-family: 'Nunito Sans', sans-serif !important;
        font-weight: 700;
    }

    .custom-action-btn {
        background-color: #516FE9 !important;
        color: white !important;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        border: none;
        font-weight: 700;
        font-size: 14px;
        transition: transform 0.1s ease, box-shadow 0.2s ease;
        cursor: pointer;
    }

    .custom-action-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 6px -1px rgba(81, 111, 233, 0.4);
    }

    .custom-action-btn:active {
        transform: scale(0.98);
    }

    .custom-card {
        background-color: #F5F6FA !important;
        border: 1px solid #E5E7EB;
    }

    [data-theme="dark"] .custom-card {
        background-color: #1f2937 !important;
        border: 1px solid #374151;
    }

    .custom-input {
        background-color: #F5F6FA !important;
        min-height: 40px;
    }

    [data-theme="dark"] .custom-input {
        background-color: #1f2937 !important;
    }

    .search-bar-custom {
        padding: 12px 16px !important;
        width: 100%;
        min-height: 48px;
        appearance: none; /* Remove default arrow in some browsers if needed, but usually kept for native select */
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
        padding-right: 2.5rem !important;
    }

    .social-media-card {
        transition: all 0.3s ease;
    }

    .social-media-card:hover {
        border-color: #516FE9 !important;
        box-shadow: 0 10px 25px -5px rgba(81, 111, 233, 0.15);
        transform: translateY(-2px);
    }

    .social-icon-container {
        width: 100%;
        height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #F5F6FA;
        border-radius: 12px;
        border: 1px solid #E5E7EB;
        transition: all 0.3s ease;
    }

    [data-theme="dark"] .social-icon-container {
        background-color: #374151;
        border-color: #4B5563;
    }

    .social-media-card:hover .social-icon-container {
        background-color: white;
        transform: scale(1.02);
    }

    [data-theme="dark"] .social-media-card:hover .social-icon-container {
        background-color: #1f2937;
    }

    .social-icon-container img {
        height: 48px;
        width: 48px;
        object-fit: contain;
        transition: transform 0.3s ease;
    }

    .social-media-card:hover .social-icon-container img {
        transform: scale(1.1);
    }

    /* TomSelect Customization */
    .ts-control {
        background-color: #F5F6FA !important;
        border: 1px solid #E5E7EB !important;
        border-radius: 0.5rem !important;
        padding: 0.5rem 1rem !important;
        font-family: 'Nunito Sans', sans-serif !important;
        min-height: 3rem !important;
        display: flex !important;
        align-items: center !important;
        font-size: 1rem !important;
    }

    [data-theme="dark"] .ts-control {
        background-color: #1f2937 !important;
        border-color: #374151 !important;
        color: #fff !important;
    }

    .ts-control .item {
        color: inherit !important;
    }

    .ts-dropdown {
        border-radius: 0.5rem !important;
        border: 1px solid #E5E7EB !important;
        overflow: hidden !important;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1) !important;
        z-index: 50 !important;
    }

    [data-theme="dark"] .ts-dropdown {
        background-color: #1f2937 !important;
        border-color: #374151 !important;
        color: #fff !important;
    }

    .ts-dropdown .option {
        padding: 0.75rem 1rem !important;
    }

    .ts-dropdown .active {
        background-color: #516FE9 !important;
        color: white !important;
    }
</style>
<div class="card bg-base-300 rounded-box p-6 gap-y-10 nunito-font">
    <h1 class="font-bold text-3xl text-center mb-6">Administrar Redes Sociales</h1>

    <!-- Selection Section -->
    <div class="mb-8 max-w mx-auto">
        <section class="rounded-xl bg-base-100 p-6 shadow-lg space-y-6">
            <h3 class="text-xl font-bold text-base-content flex items-center gap-2">
                Seleccionar Alcaldía
            </h3>
            
            <p class="text-sm opacity-70">
                Busca y selecciona una alcaldía para gestionar sus noticias.
            </p>

            <div class="relative">
                <select id="municipalitySearch" 
                        class="search-bar-custom block rounded-full border-0 bg-base-200 text-base-content shadow-sm ring-1 ring-inset ring-base-300 focus:bg-base-100 focus:ring-2 focus:ring-blue-500 sm:text-sm transition-all cursor-pointer" 
                        onchange="handleSearchSelection()">
                    <option value="" selected>Seleccione una alcaldía...</option>
                    @if (Model?.municipalities != null)
                    {
                        foreach (var m in Model.municipalities.OrderBy(x => x.Name))
                        {
                            <option value="@m.Id" selected="@(Model.municipality?.Id == m.Id)">@m.Name</option>
                        }
                    }
                </select>
            </div>

            <!-- Top Section: Last Added Municipality -->
            @if (lastMunicipalityId != null)
            {
                <div class="flex justify-center">
                    <div class="card bg-base-200 cursor-pointer hover:bg-base-100 transition-colors w-1/2 md:w-1/2 lg:w-1/3 pt-6"
                         onclick="loadMunicipality(@lastMunicipalityId)">
                        <div class="card-body items-center text-center p-4">
                            <h2 class="card-title text-sm opacity-70">Última Alcaldía Agregada</h2>
                            <p class="text-xl font-bold">@lastMunicipalityName</p>
                            <div class="badge badge-primary">Click para gestionar</div>
                        </div>
                    </div>
                </div>
            }
        </section>
    </div>

    <!-- Social Media Cards Grid -->
    <div id="socialMediaContainer" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 @(Model.municipality == null ? "hidden" : "")">
        @foreach (var socialType in Model.socialMediaTypes)
        {
            var existingSocial = Model.municipalitySocialMedia.FirstOrDefault(m => m.SocialMediaTypeId == socialType.Id);
            var iconName = socialType.Name?.ToLower() switch
            {
                "facebook" => "facebook.png",
                "instagram" => "instagram.png",
                "youtube" => "youtube.png",
                "tiktok" => "tiktok.png",
                "blogger" => "blogger.png",
                "x" => "x.png", 
                _ => "default.png" 
            };
            
            <div class="custom-card social-media-card group rounded-2xl p-4 flex flex-col items-center h-full">
                <!-- Icon Container -->
                <div class="social-icon-container mb-3 p-2">
                    <img src="~/images/social/@iconName" alt="@socialType.Name" onerror="this.src='https://placehold.co/48x48?text=@(socialType.Name?.Substring(0, 1))'" />
                </div>

                <!-- Social Media Name -->
                <div class="flex-grow flex flex-col justify-between w-full">
                    <div>
                        <h4 class="font-bold text-base-content text-center text-sm leading-tight mb-1 group-hover:text-blue-600">@socialType.Name</h4>
                        <div class="flex justify-center my-1">
                            <div class="h-0.5 w-6 bg-base-300 rounded-full group-hover:bg-blue-200 transition-colors"></div>
                        </div>
                    </div>
                    
                    <!-- Form -->
                    <form class="w-full social-media-form mt-2" onsubmit="saveSocialMedia(event, this)">
                        <input type="hidden" name="SocialMediaTypeId" value="@socialType.Id" />
                        <input type="hidden" name="MunicipalityId" value="@(Model.municipality?.Id ?? 0)" class="municipality-id-input" />
                        <input type="hidden" name="Id" value="@(existingSocial?.Id ?? 0)" />

                        <div class="form-control w-full mb-2">
                            <input type="text" name="Url" placeholder="Enlace..." 
                                   class="custom-input input input-bordered input-sm w-full rounded-lg text-xs" 
                                   value="@existingSocial?.Url" />
                        </div>

                        <div class="form-control w-full mb-2">
                            <label class="label cursor-pointer justify-center gap-2 py-1">
                                <span class="label-text text-xs">Activo</span>
                                <input type="checkbox" name="IsActive" class="toggle toggle-success toggle-sm" value="true" 
                                       @(existingSocial?.IsActive == true ? "checked" : "") />
                                <input type="hidden" name="IsActive" value="false" />
                            </label>
                        </div>

                        <div class="card-actions justify-center">
                            <button type="submit" class="custom-action-btn w-full py-2 text-xs">
                                <span class="loading loading-spinner loading-xs hidden mr-1"></span>
                                Guardar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        }
    </div>
    
    <div id="emptyState" class="text-center py-10 opacity-50 @(Model.municipality != null ? "hidden" : "")">
        <span class="material-icons-outlined text-6xl mb-4">touch_app</span>
        <p class="text-xl">Seleccione un municipio para gestionar sus redes sociales</p>
    </div>
</div>

<!-- Toast Notification Container -->
<div class="toast toast-end z-50" id="toastContainer"></div>

<!-- Add TomSelect JS -->


<script>
    // Initialize TomSelect after DOM is ready
    // Initialize after DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        // No TomSelect initialization needed for native select
    });

    function loadMunicipality(id) {
        if (!id) return;
        
        // Update URL without reload
        const url = new URL(window.location);
        url.searchParams.set('id', id);
        window.history.pushState({}, '', url);

        // Update select if triggered from "Last Added" card
        const selectEl = document.getElementById('municipalitySearch');
        if (selectEl && selectEl.value != id) {
            selectEl.value = id;
        }

        // Fetch data
        fetch(`/Municipality/GetMunicipalitySocialMedia?id=${id}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateUI(id, data.data);
                } else {
                    showToast(data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Error al cargar datos', 'error');
            });
    }

    function handleSearchSelection() {
        const select = document.getElementById('municipalitySearch');
        const id = select.value;
        if (id) {
            loadMunicipality(id);
        }
    }

    function updateUI(municipalityId, socialMediaData) {
        const container = document.getElementById('socialMediaContainer');
        const emptyState = document.getElementById('emptyState');
        const forms = document.querySelectorAll('.social-media-form');

        container.classList.remove('hidden');
        emptyState.classList.add('hidden');

        forms.forEach(form => {
            // Update MunicipalityId
            form.querySelector('.municipality-id-input').value = municipalityId;
            
            const typeId = parseInt(form.querySelector('input[name="SocialMediaTypeId"]').value);
            
            // Handle potential casing differences (PascalCase vs camelCase)
            const data = socialMediaData.find(m => 
                (m.socialMediaTypeId === typeId) || 
                (m.SocialMediaTypeId === typeId)
            );

            const urlInput = form.querySelector('input[name="Url"]');
            const activeToggle = form.querySelector('input[type="checkbox"][name="IsActive"]');
            const idInput = form.querySelector('input[name="Id"]');

            if (data) {
                // Handle casing for properties too
                urlInput.value = data.url || data.Url || '';
                activeToggle.checked = (data.isActive === true || data.IsActive === true);
                idInput.value = data.id || data.Id;
            } else {
                urlInput.value = '';
                activeToggle.checked = false;
                idInput.value = 0;
            }
        });
    }

    function saveSocialMedia(event, form) {
        event.preventDefault();
        
        const btn = form.querySelector('button[type="submit"]');
        const spinner = btn.querySelector('.loading');
        
        // UI Loading State
        btn.disabled = true;
        spinner.classList.remove('hidden');
        
        const formData = new FormData(form);
        const id = parseInt(formData.get('Id'));
        const isUpdate = id > 0;
        
        const action = isUpdate ? 'updateMunicipalitySocialMedium' : 'CreateMuncipalitySocialMedia';
        const url = `/Municipality/${action}`;

        // If update, we need to append the ID to the URL query string as per the controller signature
        const fetchUrl = isUpdate ? `${url}?id=${id}` : url;

        fetch(fetchUrl, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message || 'Guardado correctamente', 'success');
                if (!isUpdate) {
                    const municipalityId = formData.get('MunicipalityId');
                    loadMunicipality(municipalityId);
                }
            } else {
                showToast(data.message || 'Error al guardar', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error de conexión', 'error');
        })
        .finally(() => {
            btn.disabled = false;
            spinner.classList.add('hidden');
        });
    }

    function showToast(message, type = 'info') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `alert alert-${type}`;
        toast.innerHTML = `<span>${message}</span>`;
        
        container.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }
</script>